{% extends "accounts/admin/base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    /* --- 6D THEME VARIABLES --- */
    :root {
        --neon-blue: #00f3ff;
        --neon-purple: #bc13fe;
        --neon-gold: #ffd700;
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        --text-white: #ffffff;
    }

    body {
        background: radial-gradient(circle at 10% 20%, rgb(10, 10, 25) 0%, rgb(5, 5, 15) 90%);
        font-family: 'Poppins', sans-serif;
        color: var(--text-white);
        margin: 0;
    }

    .page { padding: 30px; }

    /* --- UTILITIES --- */
    .gradient-text {
        background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
    }

    /* --- GLASS CARDS --- */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: var(--glass-border);
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--glass-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
    }

    /* Neon Top Border */
    .glass-card::after {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
        background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
    }

    /* --- HEADER & ACTIONS --- */
    .header-section {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
    }

    .action-btn {
        background: linear-gradient(135deg, var(--neon-purple), #764ba2);
        color: white; padding: 10px 20px; border: none; border-radius: 50px;
        cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;
        transition: 0.3s; text-decoration: none;
    }
    
    .action-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--neon-purple); }
    .btn-print { background: linear-gradient(135deg, #FF9966, #FF5E62); }

    /* --- STATS GRID --- */
    .stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;
    }
    
    .stat-box h3 { margin: 0; font-size: 0.9rem; opacity: 0.7; }
    .stat-number { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
    .stat-icon { position: absolute; right: 20px; top: 20px; font-size: 3rem; opacity: 0.1; }

    /* --- CHARTS GRID --- */
    .charts-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;
    }
    .chart-container { height: 350px; width: 100%; }

    /* --- TABLES --- */
    .section-title { margin-bottom: 20px; border-left: 4px solid var(--neon-blue); padding-left: 15px; }

    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    
    th {
        color: var(--neon-blue); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
        padding: 15px; text-align: left;
    }
    
    tbody tr {
        background: rgba(255,255,255,0.03); transition: 0.3s;
    }
    
    tbody tr:hover {
        background: rgba(255,255,255,0.1); transform: scale(1.01); cursor: pointer;
    }

    td { padding: 15px; vertical-align: middle; }
    td:first-child { border-radius: 10px 0 0 10px; }
    td:last-child { border-radius: 0 10px 10px 0; }

    /* --- AVATARS --- */
    .avatar {
        width: 35px; height: 35px; border-radius: 50%;
        background: linear-gradient(45deg, #00f3ff, #0066ff);
        display: inline-flex; justify-content: center; align-items: center;
        font-weight: bold; margin-right: 10px; font-size: 0.8rem;
    }

    /* --- PRINT STYLES --- */
    @media print {
        body { background: white; color: black; }
        .glass-card { box-shadow: none; border: 1px solid #ccc; backdrop-filter: none; background: white; color: black; }
        .gradient-text { background: none; -webkit-text-fill-color: black; color: black; }
        .action-btn { display: none; }
        th { color: black; border-bottom: 1px solid black; }
        .stat-number { color: black; }
    }
</style>

<div class="page" id="dashboardContent">

    <div class="header-section">
        <div>
            <h2 class="gradient-text" style="font-size: 2rem; margin:0;">Master Dashboard</h2>
            <p style="opacity: 0.6; margin-top: 5px;">Admin: <b>{{ admin.username }}</b> (ID: {{ admin.id }})</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="window.print()" class="action-btn btn-print"><i class="fas fa-print"></i> Print</button>
            <button onclick="downloadPDF()" class="action-btn"><i class="fas fa-file-pdf"></i> Download PDF</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="glass-card stat-box">
            <i class="fas fa-chalkboard-teacher stat-icon"></i>
            <h3>Total Trainers</h3>
            <div class="stat-number" style="color: var(--neon-blue);">{{ total_trainers }}</div>
            <span style="font-size:0.8rem; color:#00ff88;">â–² Active</span>
        </div>
        <div class="glass-card stat-box">
            <i class="fas fa-user-graduate stat-icon"></i>
            <h3>Total Students</h3>
            <div class="stat-number" style="color: var(--neon-purple);">{{ total_students }}</div>
            <span style="font-size:0.8rem; color:#00ff88;">â–² Enrolled</span>
        </div>
        <div class="glass-card stat-box">
            <i class="fas fa-layer-group stat-icon"></i>
            <h3>Total Batches</h3>
            <div class="stat-number" style="color: var(--neon-gold);">{{ batch_stats|length }}</div>
            <span style="font-size:0.8rem; opacity:0.7;">Running</span>
        </div>
    </div>

    <div class="charts-grid">
        
        <div class="glass-card">
            <h3 class="section-title">ðŸ“Š Batch Distribution</h3>
            <div id="batchChart" class="chart-container"></div>
        </div>

        <div class="glass-card">
            <h3 class="section-title">ðŸ§  Trainer Subjects</h3>
            <div id="trainerChart" class="chart-container"></div>
        </div>

    </div>

    <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        
        <div class="glass-card">
            <h3 class="section-title"><i class="fas fa-chalkboard-teacher"></i> Trainer Details</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Profile</th>
                        <th>Subject</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in trainers %}
                    <tr>
                        <td style="opacity:0.6">#{{ t.user.id }}</td>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <div class="avatar">{{ t.user.username|make_list|first|upper }}</div>
                                <div>
                                    <div style="font-weight:600">{{ t.user.username }}</div>
                                    <div style="font-size:0.7rem; opacity:0.5">Trainer</div>
                                </div>
                            </div>
                        </td>
                        <td><span style="background:rgba(0,243,255,0.1); padding:4px 8px; border-radius:5px; color:var(--neon-blue); font-size:0.8rem;">{{ t.subject }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="glass-card">
            <h3 class="section-title"><i class="fas fa-user-graduate"></i> Student Details</h3>
            <table>
                <thead>
                    <tr>
                        <th>Profile</th>
                        <th>Assigned To</th>
                        <th>Batch</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in students %}
                    <tr>
                        <td>
                            <div style="display:flex; align-items:center;">
                                <div class="avatar" style="background: linear-gradient(45deg, #bc13fe, #ff0055);">{{ s.user.username|make_list|first|upper }}</div>
                                <div>
                                    <div style="font-weight:600">{{ s.user.username }}</div>
                                    <div style="font-size:0.7rem; opacity:0.5">ID: {{ s.user.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ s.trainer.user.username }}</td>
                        <td><span style="background:rgba(255,215,0,0.1); padding:4px 8px; border-radius:5px; color:var(--neon-gold); font-size:0.8rem;">{{ s.batch.name }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    // 1. DATA PREPARATION
    // Batch Data (From Django)
    const batchLabels = [{% for b in batch_stats %}"{{ b.batch__name }}",{% endfor %}];
    const batchData = [{% for b in batch_stats %}{value: {{ b.count }}, name: "{{ b.batch__name }}"},{% endfor %}];

    // Trainer Data (Calculated via JS for demo, or pass from View)
    // We scrape the subject table to make a dynamic graph without backend changes
    const subjectCounts = {};
    {% for t in trainers %}
        var sub = "{{ t.subject }}";
        subjectCounts[sub] = (subjectCounts[sub] || 0) + 1;
    {% endfor %}
    
    const trainerData = Object.keys(subjectCounts).map(key => {
        return { value: subjectCounts[key], name: key };
    });

    // 2. CHART CONFIGURATION (ECharts)
    
    // --- Chart 1: Student Batches (3D Donut) ---
    var batchChart = echarts.init(document.getElementById('batchChart'), 'dark');
    var batchOption = {
        backgroundColor: 'transparent',
        tooltip: { trigger: 'item' },
        legend: { top: 'bottom', textStyle: { color: '#fff' } },
        series: [{
            name: 'Students',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 1 },
            label: { show: false, position: 'center' },
            emphasis: { label: { show: true, fontSize: 20, fontWeight: 'bold' } },
            data: batchData
        }]
    };
    batchChart.setOption(batchOption);

    // --- Chart 2: Trainer Subjects (Nightingale Rose) ---
    var trainerChart = echarts.init(document.getElementById('trainerChart'), 'dark');
    var trainerOption = {
        backgroundColor: 'transparent',
        tooltip: { trigger: 'item' },
        series: [{
            name: 'Subjects',
            type: 'pie',
            radius: [20, 100],
            center: ['50%', '50%'],
            roseType: 'area',
            itemStyle: { borderRadius: 8 },
            data: trainerData
        }]
    };
    trainerChart.setOption(trainerOption);

    // Handle Resize
    window.addEventListener('resize', function() {
        batchChart.resize();
        trainerChart.resize();
    });

    // 3. PDF DOWNLOAD FUNCTION
    function downloadPDF() {
        const element = document.getElementById('dashboardContent');
        const opt = {
            margin:       0.2,
            filename:     'LMS_Master_Report.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, backgroundColor: '#0f0f18' }, // Dark background for PDF
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

{% endblock %}