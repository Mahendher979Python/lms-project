{% extends "accounts/admin/base.html" %}
{% load static %}
{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
    --primary:#38f9d7;
    --bg-dark:#050914;
    --glass:rgba(255,255,255,.04);
    --border:rgba(255,255,255,.1);
    --window-bg: #1a1c23;
}

body{background:radial-gradient(circle at top,#0b1225,#02040b); color: white;}

/* Stats & Layout */
.dashboard-stats{ display:grid; grid-template-columns:280px 1fr; gap:20px; margin-bottom:25px; }
.stat-card{
    background:var(--glass); border:1px solid var(--border);
    border-radius:18px; padding:15px; backdrop-filter:blur(15px); height:210px;
}

.media-card{
    background:var(--glass); padding:25px; border-radius:22px;
    border:1px solid var(--border); box-shadow:0 30px 60px rgba(0,0,0,.6);
}

/* Table Styling */
.custom-table{ width:100%; border-spacing:0 10px; border-collapse: separate; }
.custom-table th{
    font-size:11px; letter-spacing:1px; color:#888; padding:15px;
    text-transform: uppercase; transition: 0.3s; cursor: pointer;
}
/* Table Header Hover Effect */
.custom-table th:hover { color: var(--primary); text-shadow: 0 0 10px var(--primary); }

.custom-table td{ padding:14px 15px; color:#fff; vertical-align: middle; }
.custom-table tbody tr{ background:rgba(255,255,255,.03); transition:.3s; }
.custom-table tbody tr:hover{ background:rgba(255,255,255,.08); transform:scale(1.005); }

/* Preview Trigger Box */
.preview-container{
    width:90px; height:50px; border-radius:10px; overflow:hidden;
    border:1px solid var(--border); display:flex; align-items:center;
    justify-content:center; background:#000; cursor: pointer; transition: 0.3s;
}
.preview-container:hover { border-color: var(--primary); transform: scale(1.05); }
.preview-img, .preview-video { width:100%; height:100%; object-fit:cover; }

/* Action Buttons */
.action-btn{
    background:linear-gradient(135deg,#38f9d7,#4facfe); border-radius:30px;
    padding:7px 18px; font-weight:700; color:black; border:none; text-decoration: none;
}
.search-input{
    background:#020617; border:1px solid var(--border); color:white;
    padding:8px 18px; border-radius:30px; width:200px;
}

/* MODAL / WINDOW TEMPLATE STYLE */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center; z-index: 1000;
}
.window-box {
    width: 80%; max-width: 800px; background: var(--window-bg);
    border-radius: 12px; border: 1px solid var(--border); overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
}
.window-header {
    background: #2d2f3b; padding: 10px 15px; display: flex;
    justify-content: space-between; align-items: center;
}
.window-controls { display: flex; gap: 8px; }
.control { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.close { background: #ff5f56; cursor: pointer; }
.minimize { background: #ffbd2e; }
.maximize { background: #27c93f; }
.window-title { font-size: 13px; color: #ccc; font-family: sans-serif; }
.window-content { padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 300px; }
.window-content img, .window-content video { max-width: 100%; max-height: 70vh; border-radius: 5px; }

h2, h6 { color: white; }
.badge { background: #020617; padding: 5px 10px; border-radius: 4px; }

</style>

<div class="dashboard-stats">
    <div class="stat-card">
        <h6><i class="fa-solid fa-chart-pie"></i> File Types</h6>
        <canvas id="typeChart" height="110"></canvas>
    </div>
    <div class="stat-card">
        <h6><i class="fa-solid fa-database"></i> Total Assets</h6>
        <div style="margin-top:50px">
            <h2>{{materials|length}}</h2>
            <p style="opacity:.6">Files Uploaded</p>
        </div>
    </div>
</div>

<div class="media-card">
    <div style="display:flex;justify-content:space-between;margin-bottom:20px">
        <h2><i class="fa-solid fa-photo-film"></i> Media Hub</h2>
        <div>
            <input class="search-input" id="searchInput" onkeyup="searchTable()" placeholder="Search...">
            <a href="{% url 'admin_media_upload' %}" class="action-btn">+ Upload</a>
        </div>
    </div>

    <table class="custom-table" id="mediaTable">
        <thead>
            <tr>
                <th>NAME</th>
                <th>COURSE</th>
                <th>PREVIEW</th>
                <th>BY</th>
                <th>STATUS</th>
                <th>DOWNLOAD</th>
            </tr>
        </thead>
        <tbody>
            {% for m in materials %}
            <tr>
                <td>{{m.title}}</td>
                <td><span class="badge">{{m.course.title}}</span></td>
                <td>
                    <div class="preview-container" onclick="openPreview('{{m.file.url}}', '{{m.title}}')">
                        {% if ".pdf" in m.file.url|lower %}
                            <i class="fa-solid fa-file-pdf fa-xl" style="color:#ff4d4d"></i>
                        {% elif ".mp4" in m.file.url|lower or ".mkv" in m.file.url|lower %}
                            <i class="fa-solid fa-play-circle fa-xl" style="color:var(--primary)"></i>
                        {% elif ".jpg" in m.file.url|lower or ".png" in m.file.url|lower or ".webp" in m.file.url|lower %}
                            <img src="{{m.file.url}}" class="preview-img">
                        {% else %}
                            <i class="fa-solid fa-file fa-xl"></i>
                        {% endif %}
                    </div>
                </td>
                <td>{{m.uploaded_by.username}}</td>
                <td><i class="fa-solid fa-circle-check" style="color:#38f9d7"></i> Active</td>
                <td>
                    <a href="{{m.file.url}}" download class="action-btn">
                        <i class="fa-solid fa-download"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="window-box">
        <div class="window-header">
            <div class="window-controls">
                <span class="control close" onclick="closePreview()"></span>
                <span class="control minimize"></span>
                <span class="control maximize"></span>
            </div>
            <div class="window-title" id="modalTitle">File Preview</div>
            <div style="width: 40px;"></div> </div>
        <div class="window-content" id="modalBody">
            </div>
    </div>
</div>

<script>
function searchTable(){
    let val=document.getElementById("searchInput").value.toUpperCase();
    let rows=document.querySelector("#mediaTable tbody").rows;
    for(let r of rows){
        r.style.display=r.innerText.toUpperCase().includes(val)?"":"none";
    }
}

function openPreview(url, title) {
    const modal = document.getElementById('previewModal');
    const body = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    
    modalTitle.innerText = title;
    body.innerHTML = ''; 

    let fileExt = url.split('.').pop().toLowerCase();

    if (['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(fileExt)) {
        body.innerHTML = `<img src="${url}" alt="Preview">`;
    } else if (['mp4', 'webm', 'ogg'].includes(fileExt)) {
        body.innerHTML = `<video controls autoplay style="width:100%"><source src="${url}"></video>`;
    } else if (fileExt === 'pdf') {
        body.innerHTML = `<iframe src="${url}" width="100%" height="500px"></iframe>`;
    } else {
        body.innerHTML = `<div style="text-align:center"><i class="fa-solid fa-file-lines fa-5x"></i><p style="margin-top:20px">Preview not available for this format.</p></div>`;
    }

    modal.style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
    document.getElementById('modalBody').innerHTML = ''; // Stop video/audio on close
}

// Close modal when clicking outside the window
window.onclick = function(event) {
    if (event.target == document.getElementById('previewModal')) {
        closePreview();
    }
}

// Chart initialization
new Chart(document.getElementById('typeChart'),{
    type:'doughnut',
    data:{
        labels:['Video','PDF','Images','Other'],
        datasets:[{
            data:[5, 8, 4, 2],
            backgroundColor: ['#38f9d7', '#4facfe', '#f093fb', '#666ad1'],
            borderWidth:0
        }]
    },
    options:{
        cutout:'75%',
        plugins:{
            legend:{ labels:{color:'white',font:{size:10}}, position:'bottom' }
        }
    }
});
</script>

{% endblock %}