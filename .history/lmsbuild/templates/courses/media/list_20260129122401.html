{% extends "accounts/admin/base.html" %}
{% load static %}
{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
    --primary:#38f9d7;
    --bg-dark:#050914;
    --glass:rgba(255,255,255,.05);
    --border:rgba(255,255,255,.1);
    --window-bg: #0f172a;
}

body { background: radial-gradient(circle at top,#0b1225,#02040b); color: white; font-family: 'Segoe UI', sans-serif; }

/* --- STATS BOX ALIGNMENT FIX --- */
.dashboard-stats { 
    display: grid; 
    grid-template-columns: 350px 1fr; 
    gap: 20px; 
    margin-bottom: 25px;
    align-items: stretch;
}

.stat-card {
    background: var(--glass); 
    border: 1px solid var(--border);
    border-radius: 20px; 
    padding: 20px; 
    backdrop-filter: blur(15px);
    height: 220px;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chart-container {
    flex-grow: 1;
    position: relative;
    height: 140px;
    width: 100%;
}

/* --- TABLE DESIGN & COLORS --- */
.media-card {
    background: var(--glass); 
    padding: 30px; 
    border-radius: 24px;
    border: 1px solid var(--border);
    box-shadow: 0 40px 80px rgba(0,0,0,0.5);
}

.custom-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }

/* Header Colors & Hover */
.custom-table thead th {
    padding: 15px 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: 0.3s ease;
}

.custom-table thead th:nth-child(1) { color: #38f9d7; } /* NAME */
.custom-table thead th:nth-child(2) { color: #4facfe; } /* COURSE */
.custom-table thead th:nth-child(3) { color: #f093fb; } /* PREVIEW */
.custom-table thead th:nth-child(4) { color: #f6d365; } /* BY */
.custom-table thead th:nth-child(5) { color: #5ee7df; } /* STATUS */
.custom-table thead th:nth-child(6) { color: #feb47b; } /* DOWNLOAD */

.custom-table thead th:hover {
    transform: translateY(-2px);
    text-shadow: 0 0 10px currentColor;
}

/* Row Style - Button/Card Look */
.custom-table tbody tr {
    background: rgba(255, 255, 255, 0.03);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.custom-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: scale(1.01);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.custom-table tbody td {
    padding: 15px 20px;
    vertical-align: middle;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
}

.custom-table tbody td:first-child { border-left: 1px solid var(--border); border-radius: 12px 0 0 12px; }
.custom-table tbody td:last-child { border-right: 1px solid var(--border); border-radius: 0 12px 12px 0; }

/* Components */
.preview-container {
    width: 85px; height: 48px; border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border); display: flex; align-items: center;
    justify-content: center; background: #000; cursor: pointer; transition: 0.3s;
}
.preview-container:hover { border-color: var(--primary); transform: scale(1.05); }

.badge-course {
    background: rgba(79, 172, 254, 0.15);
    color: #4facfe; padding: 5px 12px; border-radius: 6px; font-size: 12px;
}

.action-btn {
    background: linear-gradient(135deg,#38f9d7,#4facfe); border-radius: 30px;
    padding: 8px 20px; font-weight: 700; color: #000; border: none; text-decoration: none;
    display: inline-flex; align-items: center; gap: 8px; transition: 0.3s;
}
.action-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(56, 249, 215, 0.4); }

.search-input {
    background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white;
    padding: 10px 20px; border-radius: 30px; width: 250px; outline: none;
}

/* --- WINDOW STYLE MODAL --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
    display: none; align-items: center; justify-content: center; z-index: 9999;
}
.window-box {
    width: 90%; max-width: 800px; background: var(--window-bg);
    border-radius: 15px; border: 1px solid var(--border); overflow: hidden;
}
.window-header {
    background: rgba(255,255,255,0.05); padding: 12px 20px; display: flex;
    justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);
}
.window-controls { display: flex; gap: 8px; }
.dot { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; }
.dot-red { background: #ff5f56; }
.dot-yellow { background: #ffbd2e; }
.dot-green { background: #27c93f; }
.window-content { padding: 25px; display: flex; justify-content: center; min-height: 300px; }

</style>

<div class="dashboard-stats">
    <div class="stat-card">
        <h6 style="margin-bottom: 10px; color: #888;"><i class="fa-solid fa-chart-pie"></i> File Distribution</h6>
        <div class="chart-container">
            <canvas id="typeChart"></canvas>
        </div>
    </div>

    <div class="stat-card" style="justify-content: center;">
        <h6 style="position: absolute; top: 20px; color: #888;"><i class="fa-solid fa-database"></i> Media Statistics</h6>
        <div>
            <h2 style="font-size: 50px; margin: 0; background: linear-gradient(to right, #38f9d7, #4facfe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                {{materials|length}}
            </h2>
            <p style="opacity: 0.5; margin: 5px 0 0 0;">Total Files Uploaded</p>
        </div>
    </div>
</div>

<div class="media-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
        <h2 style="margin:0;"><i class="fa-solid fa-photo-film" style="color: var(--primary);"></i> Media Hub</h2>
        <div style="display:flex; gap:15px;">
            <input class="search-input" id="searchInput" onkeyup="searchTable()" placeholder="Search by name or course...">
            <a href="{% url 'admin_media_upload' %}" class="action-btn">
                <i class="fa-solid fa-plus"></i> Upload
            </a>
        </div>
    </div>

    <table class="custom-table" id="mediaTable">
        <thead>
            <tr>
                <th style="width: 25%;">Name</th>
                <th style="width: 15%;">Course</th>
                <th style="width: 15%;">Preview</th>
                <th style="width: 15%;">By</th>
                <th style="width: 15%;">Status</th>
                <th style="width: 15%; text-align: center;">Download</th>
            </tr>
        </thead>
        <tbody>
            {% for m in materials %}
            <tr>
                <td style="font-weight: 600;">{{m.title}}</td>
                <td><span class="badge-course">{{m.course.title}}</span></td>
                <td>
                    <div class="preview-container" onclick="openPreview('{{m.file.url}}', '{{m.title}}')">
                        {% if ".pdf" in m.file.url|lower %}
                            <i class="fa-solid fa-file-pdf" style="color:#ff5f56; font-size:20px;"></i>
                        {% elif ".mp4" in m.file.url|lower %}
                            <i class="fa-solid fa-circle-play" style="color:var(--primary); font-size:20px;"></i>
                        {% else %}
                            <img src="{{m.file.url}}" class="preview-img" style="width:100%; height:100%; object-fit:cover;">
                        {% endif %}
                    </div>
                </td>
                <td style="opacity: 0.8;">{{m.uploaded_by.username}}</td>
                <td><span style="color: var(--primary); font-size: 13px;"><i class="fa-solid fa-circle-check"></i> Active</span></td>
                <td style="text-align: center;">
                    <a href="{{m.file.url}}" download class="action-btn" style="padding: 8px 12px; border-radius: 12px;">
                        <i class="fa-solid fa-download"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="window-box">
        <div class="window-header">
            <div class="window-controls">
                <span class="dot dot-red" onclick="closePreview()"></span>
                <span class="dot dot-yellow"></span>
                <span class="dot dot-green"></span>
            </div>
            <div id="modalTitle" style="font-size: 12px; color: #888; font-weight: 600;">File Preview</div>
            <div style="width: 40px;"></div>
        </div>
        <div class="window-content" id="modalBody">
            </div>
    </div>
</div>

<script>
// Search Functionality
function searchTable() {
    let input = document.getElementById("searchInput").value.toUpperCase();
    let rows = document.querySelectorAll("#mediaTable tbody tr");
    rows.forEach(row => {
        row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
    });
}

// Preview Modal Logic
function openPreview(url, title) {
    const modal = document.getElementById('previewModal');
    const body = document.getElementById('modalBody');
    document.getElementById('modalTitle').innerText = title;
    
    let ext = url.split('.').pop().toLowerCase();
    if (['jpg','jpeg','png','webp','gif'].includes(ext)) {
        body.innerHTML = `<img src="${url}" style="max-width:100%; max-height:70vh; border-radius:8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">`;
    } else if (['mp4','webm'].includes(ext)) {
        body.innerHTML = `<video controls autoplay style="width:100%; border-radius:8px;"><source src="${url}"></video>`;
    } else if (ext === 'pdf') {
        body.innerHTML = `<iframe src="${url}" width="100%" height="500px" style="border:none; border-radius:8px;"></iframe>`;
    } else {
        body.innerHTML = `<div style="text-align:center;"><i class="fa-solid fa-file-circle-exclamation fa-4x" style="color:#555;"></i><p style="margin-top:15px;">Preview not available for this file type.</p></div>`;
    }
    modal.style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
    document.getElementById('modalBody').innerHTML = '';
}

// Chart Visualization
new Chart(document.getElementById('typeChart'), {
    type: 'doughnut',
    data: {
        labels: ['Video', 'PDF', 'Images', 'Other'],
        datasets: [{
            data: [5, 8, 4, 2],
            backgroundColor: ['#38f9d7', '#4facfe', '#f093fb', '#f6d365'],
            borderWidth: 0,
            hoverOffset: 10
        }]
    },
    options: {
        maintainAspectRatio: false,
        cutout: '78%',
        plugins: {
            legend: {
                position: 'right',
                labels: { color: '#888', font: { size: 11 }, usePointStyle: true, padding: 15 }
            }
        }
    }
});
</script>

{% endblock %}