{% extends "accounts/admin/base.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
  :root {
    --bg-dark: #0f172a;
    --card-bg: rgba(30, 41, 59, 0.7); /* Translucent */
    --neon-blue: #3b82f6;
    --neon-purple: #8b5cf6;
    --neon-green: #10b981;
    --neon-red: #ef4444;
    --text-main: #f1f5f9;
  }

  .media-dashboard {
    background: var(--bg-dark);
    min-height: 100vh;
    padding: 30px;
    font-family: 'Segoe UI', sans-serif;
    color: var(--text-main);
    background-image: 
        radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
  }

  /* --- HEADER & ANALYTICS --- */
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 30px;
  }
  
  .stats-row {
    display: grid;
    grid-template-columns: 2fr 1fr; /* 2:1 Ratio */
    gap: 20px;
    margin-bottom: 40px;
  }

  .glass-panel {
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .panel-title {
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #94a3b8;
    margin-bottom: 15px;
  }

  /* --- SEARCH & CONTROLS --- */
  .control-bar {
    display: flex;
    gap: 15px;
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 30px;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 16px;
    padding: 10px;
    border-bottom: 2px solid #334155;
    transition: 0.3s;
  }
  .search-input:focus {
    outline: none;
    border-color: var(--neon-blue);
  }

  .filter-select {
    background: #1e293b;
    color: white;
    border: 1px solid #475569;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
  }

  .btn-add {
    background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
    color: white;
    padding: 10px 25px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    transition: 0.3s;
  }
  .btn-add:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6); }

  /* --- MEDIA GRID (3D CARDS) --- */
  .section-heading {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 700;
    color: var(--text-main);
  }

  .media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 50px;
    perspective: 1000px; /* Essential for 3D effect */
  }

  .media-card {
    background: #1e293b;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s;
    border: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    group: hover;
  }

  .media-card:hover {
    transform: rotateX(5deg) translateY(-10px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    z-index: 10;
  }

  .thumb-wrapper {
    height: 160px;
    background: #0f172a;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .thumb-wrapper img, .thumb-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.8;
    transition: 0.3s;
  }

  .media-card:hover .thumb-wrapper img {
    opacity: 1;
    transform: scale(1.1);
  }

  .play-icon {
    position: absolute;
    font-size: 40px;
    color: white;
    opacity: 0.7;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    transition: 0.3s;
  }
  .media-card:hover .play-icon { opacity: 1; transform: scale(1.2); text-shadow: 0 0 20px var(--neon-blue); }

  .card-body {
    padding: 15px;
  }

  .media-title {
    font-weight: 600;
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .media-meta {
    font-size: 12px;
    color: #94a3b8;
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .status-dot {
    height: 8px;
    width: 8px;
    border-radius: 50%;
    display: inline-block;
  }

  .card-actions {
    display: flex;
    gap: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
  }

  .action-btn {
    flex: 1;
    text-align: center;
    padding: 6px;
    border-radius: 6px;
    font-size: 12px;
    text-decoration: none;
    color: #cbd5e1;
    background: rgba(255,255,255,0.05);
    transition: 0.2s;
  }
  .btn-edit:hover { background: var(--neon-blue); color: white; }
  .btn-del:hover { background: var(--neon-red); color: white; }
  .btn-dl:hover { background: var(--neon-green); color: white; }

  /* --- MODAL --- */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(5px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s;
  }
  
  .modal-content {
    width: 90%;
    max-width: 900px;
    position: relative;
    background: transparent;
    border-radius: 12px;
    box-shadow: 0 0 50px rgba(59, 130, 246, 0.2);
  }

  .close-modal {
    position: absolute;
    top: -40px;
    right: 0;
    color: white;
    font-size: 30px;
    cursor: pointer;
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

</style>

<div class="media-dashboard">

  <div class="stats-row">
    <div class="glass-panel">
      <div class="panel-title">üìä Media Distribution</div>
      <div id="mediaChart" style="height: 200px;"></div>
    </div>
    
    <div class="glass-panel">
      <div class="panel-title">üíæ Storage Usage</div>
      <div id="storageChart" style="height: 200px;"></div>
    </div>
  </div>

  <form method="get" class="control-bar">
    <span style="font-size:20px;">üîç</span>
    <input type="text" name="search" class="search-input" placeholder="Search videos or ads..." value="{{ search }}">
    
    <select name="status" class="filter-select">
      <option value="">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
    
    <button type="submit" class="btn-add" style="border:none; cursor:pointer;">Filter</button>
    <a href="{% url 'admin_media_list' %}" style="color:#94a3b8; text-decoration:none; margin-left:10px;">Reset</a>
  </form>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div class="section-heading">üé¨ Session Videos</div>
    <a href="/admin/courses/sessionvideo/add/" class="btn-add">+ Upload Video</a>
  </div>

  <div class="media-grid">
    {% for video in videos %}
    <div class="media-card">
      <div class="thumb-wrapper" onclick="playVideo('{{ video.video.url }}')">
        <video src="{{ video.video.url }}#t=2" muted style="pointer-events: none;"></video>
        <div class="play-icon">‚ñ∂</div>
      </div>
      <div class="card-body">
        <div class="media-title" title="{{ video.title }}">{{ video.title }}</div>
        <div class="media-meta">
          <span>
            {% if video.is_active %}
              <span class="status-dot" style="background:var(--neon-green);"></span> Active
            {% else %}
              <span class="status-dot" style="background:var(--neon-red);"></span> Inactive
            {% endif %}
          </span>
          <span>MP4</span>
        </div>
        <div class="card-actions">
          <a href="{{ video.video.url }}" download class="action-btn btn-dl" title="Download">‚¨á</a>
          <a href="/admin/courses/sessionvideo/{{ video.id }}/change/" class="action-btn btn-edit">Edit</a>
          <a href="/admin/courses/sessionvideo/{{ video.id }}/delete/" class="action-btn btn-del" onclick="return confirm('Delete?')">Delete</a>
        </div>
      </div>
    </div>
    {% empty %}
      <p style="color:#64748b; col-span:3;">No videos found.</p>
    {% endfor %}
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:50px;">
    <div class="section-heading">üñºÔ∏è Advertisements</div>
    <a href="/admin/courses/advertisement/add/" class="btn-add">+ Add Banner</a>
  </div>

  <div class="media-grid">
    {% for ad in ads %}
    <div class="media-card">
      <div class="thumb-wrapper" onclick="showImage('{{ ad.image.url }}')">
        <img src="{{ ad.image.url }}" alt="Ad">
        <div class="play-icon" style="font-size:25px;">üëÅ</div>
      </div>
      <div class="card-body">
        <div class="media-title">{{ ad.title }}</div>
        <div class="media-meta">
          <span>
             {% if ad.is_active %}
              <span class="status-dot" style="background:var(--neon-green);"></span> Live
            {% else %}
              <span class="status-dot" style="background:var(--neon-red);"></span> Paused
            {% endif %}
          </span>
          <span>JPG/PNG</span>
        </div>
        <div class="card-actions">
          <a href="{{ ad.image.url }}" download class="action-btn btn-dl">‚¨á</a>
          <a href="/admin/courses/advertisement/{{ ad.id }}/change/" class="action-btn btn-edit">Edit</a>
          <a href="/admin/courses/advertisement/{{ ad.id }}/delete/" class="action-btn btn-del" onclick="return confirm('Delete?')">Delete</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</div>

<div id="mediaModal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="close-modal" onclick="closeModal()">√ó</div>
    <div id="modalBody" style="display:flex; justify-content:center;"></div>
  </div>
</div>

<script>
  // --- 1. APEX CHARTS CONFIGURATION ---
  
  // Media Type Area Chart
  var optionsMedia = {
    series: [{
      name: 'Content Count',
      data: [{{ videos|length }}, {{ ads|length }}] // Backend Data
    }],
    chart: { type: 'bar', height: 200, toolbar: {show:false}, background: 'transparent' },
    colors: ['#3b82f6'],
    xaxis: { categories: ['Videos', 'Ads'], labels: { style: { colors: '#94a3b8' } } },
    yaxis: { labels: { style: { colors: '#94a3b8' } } },
    theme: { mode: 'dark' },
    grid: { borderColor: '#334155' }
  };
  var chart1 = new ApexCharts(document.querySelector("#mediaChart"), optionsMedia);
  chart1.render();

  // Storage Radial Chart (Mock Data for Visual)
  var optionsStorage = {
    series: [70],
    chart: { type: 'radialBar', height: 220, background: 'transparent' },
    plotOptions: {
      radialBar: {
        hollow: { size: '60%' },
        dataLabels: {
          name: { show: true, color: '#fff' },
          value: { color: '#fff', fontSize: '20px', show: true }
        },
        track: { background: '#334155' }
      }
    },
    colors: ['#8b5cf6'],
    labels: ['Storage'],
    theme: { mode: 'dark' }
  };
  var chart2 = new ApexCharts(document.querySelector("#storageChart"), optionsStorage);
  chart2.render();


  // --- 2. MODAL LOGIC ---
  const modal = document.getElementById('mediaModal');
  const modalBody = document.getElementById('modalBody');

  function playVideo(url) {
    modalBody.innerHTML = `
      <video controls autoplay style="width:100%; max-height:80vh; border-radius:8px; box-shadow:0 0 30px rgba(0,0,0,0.8);">
        <source src="${url}" type="video/mp4">
      </video>`;
    modal.style.display = 'flex';
  }

  function showImage(url) {
    modalBody.innerHTML = `
      <img src="${url}" style="max-width:100%; max-height:80vh; border-radius:8px; box-shadow:0 0 30px rgba(0,0,0,0.8);">`;
    modal.style.display = 'flex';
  }

  function closeModal() {
    modal.style.display = 'none';
    modalBody.innerHTML = ''; // Stop playback
  }
</script>

{% endblock %}