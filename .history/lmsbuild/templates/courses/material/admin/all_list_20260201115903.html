{% extends "accounts/admin/base.html" %}
{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* --- Modern UI Design --- */
    .library-body { font-family: 'Poppins', sans-serif; color: #334155; }

    .header-bar {
        background: #ffffff;
        padding: 25px;
        border-radius: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }

    .btn-3d-main {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: #ffffff !important;
        padding: 12px 25px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.3s ease;
        box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        border: none;
        cursor: pointer;
    }

    .btn-3d-main:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(79, 70, 229, 0.4); }

    .section-label {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 40px 0 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #1e293b;
    }

    /* --- 3D Grid & Card --- */
    .grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 25px;
    }

    .card-glass {
        background: #ffffff;
        border-radius: 20px;
        padding: 20px;
        border: 1px solid #f1f5f9;
        box-shadow: 0 10px 25px rgba(0,0,0,0.03);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .card-glass:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        border-color: #4f46e5;
    }

    .file-thumb {
        height: 150px;
        background: #f8fafc;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .file-thumb img, .file-thumb video { width: 100%; height: 100%; object-fit: cover; }

    .btn-action-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }

    .btn-action {
        flex: 1;
        padding: 8px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        transition: 0.2s;
    }

    .view { background: #eef2ff; color: #4f46e5; }
    .save { background: #ecfdf5; color: #10b981; }
    .edit { background: #fffbeb; color: #f59e0b; }
    .delete { background: #fef2f2; color: #ef4444; }

    /* --- PDF Preview Modal --- */
    .pdf-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(10px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .modal-box {
        width: 90%;
        height: 90%;
        background: #ffffff;
        border-radius: 24px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-nav {
        padding: 15px 25px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
    }

    .close-trigger { font-size: 24px; cursor: pointer; color: #ef4444; transition: 0.3s; }
    .close-trigger:hover { transform: rotate(90deg); }

    #pdfViewer { flex: 1; border: none; }

    /* --- Upload Selector --- */
    .upload-box { max-width: 450px; height: auto; padding: 30px; text-align: center; }
</style>

<div class="library-body">
    
    <div class="header-bar">
        <div>
            <h2 style="margin:0;">Material Library</h2>
            <p style="margin:0; color:#64748b; font-size:0.9rem;">Access and manage all curriculum files.</p>
        </div>
        <button class="btn-3d-main" onclick="toggleUploadModal()">
            <i class="fa-solid fa-plus-circle"></i> Upload New
        </button>
    </div>

    <div id="pdfModal" class="pdf-modal">
        <div class="modal-box">
            <div class="modal-nav">
                <h4 id="modalTitle" style="margin:0;">Document Preview</h4>
                <span class="close-trigger" onclick="closePdf()">&times;</span>
            </div>
            <div id="modalContent" style="flex:1;"></div>
        </div>
    </div>

    <div id="uploadSelector" class="pdf-modal">
        <div class="modal-box upload-box">
            <h3 style="margin-bottom:10px;">Select Course</h3>
            <p style="color:#64748b;">Choose a course to upload the material.</p>
            <select id="courseId" style="width:100%; padding:12px; border-radius:10px; border:1px solid #cbd5e1; margin:20px 0;">
                {% for c in courses %}
                <option value="{{c.id}}">{{c.title}}</option>
                {% endfor %}
            </select>
            <button class="btn-3d-main" onclick="redirectUpload()" style="width:100%; justify-content:center;">Continue</button>
            <p onclick="toggleUploadModal()" style="margin-top:15px; cursor:pointer; color:#ef4444; font-weight:600;">Cancel</p>
        </div>
    </div>

    <div class="section-label"><i class="fa-solid fa-file-pdf" style="color:#ef4444;"></i> PDF Documents</div>
    <div class="grid-layout">
        {% for m in materials %}
        {% if m.file.url|lower|slice:"-4:" == ".pdf" %}
        <div class="card-glass">
            <div class="file-thumb" style="background:#fef2f2;">
                <i class="fa-solid fa-file-pdf fa-4x" style="color:#ef4444;"></i>
            </div>
            <div style="font-weight:600; text-align:center; min-height:40px;">{{m.title}}</div>
            <div class="btn-action-group">
                <button class="btn-action view" onclick="openPdf('{{m.file.url}}', '{{m.title}}')">Open</button>
                <a class="btn-action save" href="{{m.file.url}}" download>Save</a>
                <a class="btn-action edit" href="{% url 'admin_material_edit' m.id %}"><i class="fa-solid fa-pen"></i></a>
                <a class="btn-action delete" href="{% url 'admin_material_delete' m.id %}" onclick="return confirm('Delete?')"><i class="fa-solid fa-trash"></i></a>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="section-label"><i class="fa-solid fa-image" style="color:#3b82f6;"></i> Media Library</div>
    <div class="grid-layout">
        {% for m in materials %}
        {% if m.file.url|lower|slice:"-4:" == ".jpg" or m.file.url|lower|slice:"-4:" == ".png" %}
        <div class="card-glass">
            <div class="file-thumb">
                <img src="{{m.file.url}}">
            </div>
            <div style="font-weight:600; text-align:center; min-height:40px;">{{m.title}}</div>
            <div class="btn-action-group">
                <button class="btn-action view" onclick="openImage('{{m.file.url}}', '{{m.title}}')">Preview</button>
                <a class="btn-action save" href="{{m.file.url}}" download>Save</a>
                <a class="btn-action edit" href="{% url 'admin_material_edit' m.id %}"><i class="fa-solid fa-pen"></i></a>
                <a class="btn-action delete" href="{% url 'admin_material_delete' m.id %}" onclick="return confirm('Delete?')"><i class="fa-solid fa-trash"></i></a>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="section-label"><i class="fa-solid fa-circle-play" style="color:#8b5cf6;"></i> Video Lectures</div>
    <div class="grid-layout">
        {% for m in materials %}
        {% if m.file.url|lower|slice:"-4:" == ".mp4" %}
        <div class="card-glass">
            <div class="file-thumb" style="background:#000;">
                <video muted><source src="{{m.file.url}}"></video>
                <div style="position:absolute; color:#fff;"><i class="fa-solid fa-play fa-2x"></i></div>
            </div>
            <div style="font-weight:600; text-align:center; min-height:40px;">{{m.title}}</div>
            <div class="btn-action-group">
                <button class="btn-action view" onclick="openVideo('{{m.file.url}}', '{{m.title}}')">Play</button>
                <a class="btn-action save" href="{{m.file.url}}" download>Save</a>
                <a class="btn-action edit" href="{% url 'admin_material_edit' m.id %}"><i class="fa-solid fa-pen"></i></a>
                <a class="btn-action delete" href="{% url 'admin_material_delete' m.id %}" onclick="return confirm('Delete?')"><i class="fa-solid fa-trash"></i></a>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

</div>

<script>
    function openPdf(url, title) {
        const container = document.getElementById('modalContent');
        document.getElementById('modalTitle').innerText = title;
        // Using embed with type application/pdf forces browser view
        container.innerHTML = `<embed src="${url}#toolbar=1" type="application/pdf" width="100%" height="100%">`;
        document.getElementById('pdfModal').style.display = 'flex';
    }

    function openImage(url, title) {
        const container = document.getElementById('modalContent');
        document.getElementById('modalTitle').innerText = title;
        container.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;padding:20px;">
                                <img src="${url}" style="max-width:100%; max-height:100%; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
                               </div>`;
        document.getElementById('pdfModal').style.display = 'flex';
    }

    function openVideo(url, title) {
        const container = document.getElementById('modalContent');
        document.getElementById('modalTitle').innerText = title;
        container.innerHTML = `<video controls autoplay style="width:100%;height:100%;background:#000;"><source src="${url}"></video>`;
        document.getElementById('pdfModal').style.display = 'flex';
    }

    function closePdf() {
        document.getElementById('pdfModal').style.display = 'none';
        document.getElementById('modalContent').innerHTML = '';
    }

    function toggleUploadModal() {
        const modal = document.getElementById('uploadSelector');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function redirectUpload() {
        const cid = document.getElementById('courseId').value;
        window.location.href = `/courses/admin/courses/${cid}/materials/upload/`;
    }

    // Close modal on background click
    window.onclick = function(event) {
        if (event.target.className === 'pdf-modal') {
            closePdf();
            toggleUploadModal();
        }
    }
</script>

{% endblock %}