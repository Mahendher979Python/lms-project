{% extends "accounts/student/base.html" %}
{% block content %}
<form hidden>{% csrf_token %}</form>

<style>
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px}
.btn{padding:10px 18px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
.btn-login{background:#22c55e;color:#fff}
.btn-logout{background:#ef4444;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f1f5f9}
</style>

<div class="card">
  <h2>üìç Attendance Tracker</h2>
  <button class="btn btn-login" onclick="markLogin()">Login</button>
  <button class="btn btn-logout" onclick="markLogout()">Logout</button>
  <iframe id="map" width="100%" height="280" style="display:none;margin-top:15px;border-radius:10px"></iframe>
</div>

<div class="card">
  <h3>üìÖ Attendance History</h3>
  <table>
    <tr>
      <th>Date</th><th>Login</th><th>Logout</th><th>Work Hours</th><th>Location</th>
    </tr>
    {% for a in attendance_list %}
    <tr>
      <td>{{ a.date }}</td>
      <td>{{ a.login_time|default:"-" }}</td>
      <td>{{ a.logout_time|default:"-" }}</td>
      <td>{{ a.total_work_hours|default:"-" }}</td>
      <td>
        {% if a.latitude %}
        <a target="_blank" href="https://www.google.com/maps?q={{a.latitude}},{{a.longitude}}">
          View
        </a>
        {% else %}-{% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
</div>

<script>
function csrf(){return document.querySelector('[name=csrfmiddlewaretoken]').value;}

function markLogin(){
 navigator.geolocation.getCurrentPosition(p=>{
  fetch("{% url 'attendance_login' %}",{
   method:"POST",
   headers:{
    "X-CSRFToken":csrf(),
    "Content-Type":"application/json"
   },
   body:JSON.stringify({
    latitude:p.coords.latitude,
    longitude:p.coords.longitude
   })
  }).then(()=>{
    const map=document.getElementById("map");
    map.style.display="block";
    map.src=`https://maps.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}&z=15&output=embed`;
    setTimeout(()=>location.reload(),800);
  });
 });
}

function markLogout(){
 fetch("{% url 'attendance_logout' %}",{
  method:"POST",
  headers:{"X-CSRFToken":csrf()}
 }).then(()=>setTimeout(()=>location.reload(),800));
}
</script>
{% endblock %}
