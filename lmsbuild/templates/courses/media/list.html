{% extends "accounts/admin/base.html" %}
{% load static %}
{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --primary: #38f9d7;
    --secondary: #4facfe;
    --bg-dark: #050914;
    --glass: rgba(255, 255, 255, 0.05);
    --border: rgba(255, 255, 255, 0.1);
    --window-bg: #0f172a;
    --danger: #ff4d4d;
}

/* Page Background Setup */
body { 
    background: radial-gradient(circle at top, #0b1225, #02040b) !important; 
    color: white; 
    font-family: 'Inter', sans-serif;
}

/* --- DASHBOARD STATS --- */
.dashboard-stats { 
    display: grid; 
    grid-template-columns: 350px 1fr; 
    gap: 20px; 
    margin-bottom: 25px;
    align-items: stretch;
}

.stat-card {
    background: var(--glass); 
    border: 1px solid var(--border);
    border-radius: 20px; 
    padding: 20px; 
    backdrop-filter: blur(15px);
    height: 220px;
    display: flex;
    flex-direction: column;
    position: relative;
}

.chart-container {
    flex-grow: 1;
    position: relative;
    height: 140px;
    width: 100%;
}

/* --- MEDIA HUB TABLE --- */
.media-card {
    background: var(--glass); 
    padding: 30px; 
    border-radius: 24px;
    border: 1px solid var(--border);
    box-shadow: 0 40px 80px rgba(0,0,0,0.5);
}

.custom-table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0 12px; 
}

.custom-table thead th {
    padding: 15px 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: left;
}

/* Header colors */
.custom-table thead th:nth-child(1) { color: #38f9d7; }
.custom-table thead th:nth-child(2) { color: #4facfe; }
.custom-table thead th:nth-child(3) { color: #f093fb; }
.custom-table thead th:nth-child(4) { color: #f6d365; }
.custom-table thead th:nth-child(5) { color: #5ee7df; }
.custom-table thead th:nth-child(6) { color: #feb47b; text-align: center; }

.custom-table tbody tr {
    background: rgba(255, 255, 255, 0.03);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.custom-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: scale(1.01);
}

.custom-table tbody td {
    padding: 15px 20px;
    vertical-align: middle;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
}

.custom-table tbody td:first-child { border-left: 1px solid var(--border); border-radius: 12px 0 0 12px; }
.custom-table tbody td:last-child { border-right: 1px solid var(--border); border-radius: 0 12px 12px 0; }

/* --- ACTIONS STYLE --- */
.view-preview-btn {
    background: rgba(240, 147, 251, 0.1);
    border: 1px solid rgba(240, 147, 251, 0.3);
    color: #f093fb; padding: 6px 14px; border-radius: 8px; font-size: 11px;
    cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px;
}

.view-preview-btn:hover { background: #f093fb; color: #000; }

.hub-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
}

.hub-link {
    font-size: 1.1rem;
    transition: 0.3s;
}

.hub-edit { color: var(--secondary); }
.hub-edit:hover { color: #fff; text-shadow: 0 0 10px var(--secondary); }

.hub-download { color: var(--primary); }
.hub-download:hover { color: #fff; text-shadow: 0 0 10px var(--primary); }

.hub-delete { color: var(--danger); }
.hub-delete:hover { color: #fff; text-shadow: 0 0 10px var(--danger); }

/* Form Controls */
.search-input {
    background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white;
    padding: 10px 20px; border-radius: 30px; width: 250px; outline: none;
}

.action-btn {
    background: linear-gradient(135deg, #38f9d7, #4facfe); border-radius: 30px;
    padding: 8px 20px; font-weight: 700; color: #000; text-decoration: none;
    display: inline-flex; align-items: center; gap: 8px; transition: 0.3s;
}

/* Modal Styling */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
    display: none; align-items: center; justify-content: center; z-index: 9999;
}
.window-box {
    width: 90%; max-width: 800px; background: var(--window-bg);
    border-radius: 15px; border: 1px solid var(--border); overflow: hidden;
}
.window-header {
    background: rgba(255,255,255,0.05); padding: 12px 20px; display: flex;
    justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);
}
.dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; cursor: pointer;}
.dot-red { background: #ff5f56; }
.dot-yellow { background: #ffbd2e; }
.dot-green { background: #27c93f; }
</style>

<div class="dashboard-stats">
    <div class="stat-card">
        <h6 style="margin-bottom: 10px; color: #888;"><i class="fa-solid fa-chart-pie"></i> File Distribution</h6>
        <div class="chart-container">
            <canvas id="typeChart"></canvas>
        </div>
    </div>

    <div class="stat-card" style="justify-content: center;">
        <h6 style="position: absolute; top: 20px; color: #888;"><i class="fa-solid fa-database"></i> Media Statistics</h6>
        <div>
            <h2 style="font-size: 50px; margin: 0; background: linear-gradient(to right, #38f9d7, #4facfe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                {{ materials|length }}
            </h2>
            <p style="opacity: 0.5; margin: 5px 0 0 0;">Total Files Uploaded</p>
        </div>
    </div>
</div>

<div class="media-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
        <h2 style="margin:0;"><i class="fa-solid fa-photo-film" style="color: var(--primary);"></i> Media Hub</h2>
        <div style="display:flex; gap:15px;">
            <input class="search-input" id="searchInput" onkeyup="searchTable()" placeholder="Search files...">
            <a href="{% url 'admin_media_upload' %}" class="action-btn">
                <i class="fa-solid fa-plus"></i> Upload
            </a>
        </div>
    </div>

    <table class="custom-table" id="mediaTable">
        <thead>
            <tr>
                <th style="width: 25%;">Name</th>
                <th style="width: 15%;">Course</th>
                <th style="width: 15%;">Preview</th>
                <th style="width: 12%;">By</th>
                <th style="width: 10%;">Status</th>
                <th style="width: 23%; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for m in materials %}
            <tr>
                <td style="font-weight: 600;">{{ m.title }}</td>
                <td><span style="background: rgba(79, 172, 254, 0.15); color: #4facfe; padding: 5px 12px; border-radius: 6px; font-size: 12px;">
                    {{ m.course.title }}
                </span></td>
                <td>
                    <button class="view-preview-btn" onclick="openPreview('{{ m.file.url }}', '{{ m.title }}')">
                        <i class="fa-solid fa-eye"></i> View
                    </button>
                </td>
                <td style="opacity: 0.8; font-size: 13px;">{{ m.uploaded_by.username }}</td>
                <td><span style="color: var(--primary); font-size: 13px;"><i class="fa-solid fa-circle-check"></i> Active</span></td>
                <td>
                    <div class="hub-actions">
                        <a href="{% url 'admin_media_edit' m.id %}" class="hub-link hub-edit" title="Edit">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                        <a href="{{ m.file.url }}" download class="hub-link hub-download" title="Download">
                            <i class="fa-solid fa-download"></i>
                        </a>
                        <a href="{% url 'admin_media_delete' m.id %}" 
                           onclick="return confirm('Delete permanently?')" 
                           class="hub-link hub-delete" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="window-box">
        <div class="window-header">
            <div class="window-controls">
                <span class="dot dot-red" onclick="closePreview()"></span>
                <span class="dot dot-yellow"></span>
                <span class="dot dot-green"></span>
            </div>
            <div id="modalTitle" style="font-size: 12px; color: #888; font-weight: 600;">Preview</div>
            <div style="width: 30px;"></div>
        </div>
        <div id="modalBody" style="padding: 20px; display: flex; justify-content: center; min-height: 300px;"></div>
    </div>
</div>

<script>
function searchTable() {
    let input = document.getElementById("searchInput").value.toUpperCase();
    let rows = document.querySelectorAll("#mediaTable tbody tr");
    rows.forEach(row => {
        row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
    });
}

function openPreview(url, title) {
    const modal = document.getElementById('previewModal');
    const body = document.getElementById('modalBody');
    document.getElementById('modalTitle').innerText = title;
    
    let ext = url.split('.').pop().toLowerCase();
    if (['jpg','jpeg','png','webp'].includes(ext)) {
        body.innerHTML = `<img src="${url}" style="max-width:100%; max-height:60vh; border-radius:8px;">`;
    } else if (['mp4','webm'].includes(ext)) {
        body.innerHTML = `<video controls autoplay style="width:100%; border-radius:8px;"><source src="${url}"></video>`;
    } else if (ext === 'pdf') {
        body.innerHTML = `<iframe src="${url}" width="100%" height="500px" style="border:none;"></iframe>`;
    } else {
        body.innerHTML = `<div style="text-align:center; padding:40px;"><i class="fa-solid fa-file fa-4x"></i><p>No Preview</p></div>`;
    }
    modal.style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

// Chart Logic
new Chart(document.getElementById('typeChart'), {
    type: 'doughnut',
    data: {
        labels: ['Video', 'PDF', 'Images', 'Other'],
        datasets: [{
            data: [5, 8, 4, 2],
            backgroundColor: ['#38f9d7', '#4facfe', '#f093fb', '#f6d365'],
            borderWidth: 0
        }]
    },
    options: {
        maintainAspectRatio: false,
        cutout: '80%',
        plugins: {
            legend: { position: 'right', labels: { color: '#888', font: { size: 10 }, usePointStyle: true } }
        }
    }
});
</script>

{% endblock %}